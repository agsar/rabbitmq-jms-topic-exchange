DEPS:=rabbitmq-server rabbitmq-erlang-client
RETAIN_ORIGINAL_VERSION:=true

STANDALONE_TEST_COMMANDS:=rjms_topic_selector_unit_tests:test()

# Parser source files generated by dependency:
PARSER_FILES:=src/sjx_parser.erl src/sjx_scanner.erl src/sjx_evaluator.erl src/sjx_dialect.erl

DEP_GIT:=https://github.com/Zteve/sjx.git
DEP_DIR:=$(PACKAGE_DIR)/sjx
DEP_GEN:=$(addprefix $(DEP_DIR)/, $(PARSER_FILES))

PKG_DIR:=$(PACKAGE_DIR)
PKG_GEN:=$(addprefix $(PKG_DIR)/, $(PARSER_FILES))

# Build the dependant parser and hook into exchange build:
# NOT using UPSTREAM_GIT since this is not a wrapper plugin/package
define package_rules

$(PACKAGE_DIR)+clean::
	-rm -rf $(DEP_DIR)

SOURCE_ERLS += $(PKG_GEN)

$(PACKAGE_DIR)+dist:: $(DEP_DIR)/.sps

$(DEP_DIR):
	git clone $(DEP_GIT)
	(cd $(DEP_DIR); ./rebar clean get-deps compile)
	touch $(DEP_DIR)/.ps

$(DEP_GEN): $(DEP_DIR)/.ps

$(DEP_DIR)/.ps: | $(DEP_DIR)

$(PKG_GEN): $(DEP_DIR)/.sps

$(DEP_DIR)/.sps: $(DEP_DIR)/.ps
	cp $(DEP_GEN) $(PKG_DIR)/src
	touch $$@

endef
