# Make this RabbitMQ plugin

HG_CORE_REPOBASE:=http://hg.rabbitmq.com

RABBIT_BRANCH:=rabbitmq_v2_8_7
RABBIT_DEPS:=rabbitmq-server rabbitmq-erlang-client rabbitmq-codegen
RABBIT_UMBRELLA_BASE:=rabbitmq-public-umbrella


.PHONY: all
all: dist

.PHONY: clean
clean:
	rm -rf $(RABBIT_UMBRELLA_BASE)

.PHONY: dist
dist: init
	$(MAKE) -C $(RABBIT_UMBRELLA_BASE)/rabbitmq-jms-topic-exchange dist

.PHONY: init
init: clean
	hg clone $(HG_CORE_REPOBASE)/$(RABBIT_UMBRELLA_BASE)
	mkdir -p $(RABBIT_UMBRELLA_BASE)/rabbitmq-jms-topic-exchange
	cp -R src package.mk Makefile LICENSE-* $(RABBIT_UMBRELLA_BASE)/rabbitmq-jms-topic-exchange/.
	cd $(RABBIT_UMBRELLA_BASE); hg up $(RABBIT_BRANCH)
	$(foreach DIR, $(RABBIT_DEPS), \
		(cd $(RABBIT_UMBRELLA_BASE); hg clone $(HG_CORE_REPOBASE)/$(DIR); cd $(DIR); OUT=$$(hg st -mad); \
		if \[ ! -z "$$OUT" \]; then echo "\n$(DIR):\n$$OUT"; fi; hg up $(RABBIT_BRANCH)) &&) true